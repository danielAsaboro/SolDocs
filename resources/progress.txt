2026-02-13 - Fix B4: Race condition in src/store/index.ts
  - Added FileMutex class with per-file async locking (promise-chaining pattern)
  - Added *Safe async variants for all read-modify-write Store methods:
    saveProgramSafe, removeProgramSafe, addToQueueSafe,
    updateQueueItemSafe, removeFromQueueSafe
  - Updated agent/core.ts to use *Safe methods for all store mutations
  - Updated api/routes.ts to use async handlers with *Safe methods
  - Added 11 new tests: 7 for Store mutex integration, 4 for FileMutex unit tests
  - Files changed: src/store/index.ts, src/agent/core.ts, src/api/routes.ts, src/tests/store.test.ts

2026-02-13 - Add T7: Agent tests in src/tests/agent.test.ts
  - Added 12 new tests (25 total, up from 13) across 7 new describe blocks:
    1. AI failure handling: verifies program marked failed when AI throws
    2. Error cap enforcement: confirms errors array capped at 50 entries
    3. Discovery seeding (2 tests): validates queue seeding on first start, skips when queue non-empty
    4. Documentation content structure (2 tests): validates all 4 doc sections populated, correct program metadata
    5. IDL change detection (2 tests): first-time doc generation with cached IDL, checkForUpgrades returns only documented programs
    6. Queue behavior during processing (2 tests): graceful stop mid-queue, attempt count incrementing on failure
    7. State sync with store: getState reflects external store mutations
    8. StartedAt tracking: validates startedAt updates when agent starts
  - Added import for checkForUpgrades from agent/discovery module
  - All 100 tests pass across 6 test suites, build clean
  - Files changed: src/tests/agent.test.ts

2026-02-13 - Add I4: Webhook notification on doc completion (WEBHOOK_URL env)
  - Added webhookUrl (string | null) to Config interface, loaded from WEBHOOK_URL env var
  - Created src/agent/webhook.ts with sendWebhookNotification():
    - Sends POST with JSON payload: event, programId, name, timestamp, documentation summary
    - Uses native fetch with 10s timeout via AbortSignal.timeout
  - Integrated into Agent.processProgram: notifyWebhook() called after docs saved, before queue removal
    - Webhook errors are caught and logged, never block documentation flow
  - Added 5 new tests in src/tests/agent.test.ts (webhook notification on doc completion):
    1. Sends POST to WEBHOOK_URL with correct payload structure
    2. Does not send webhook when WEBHOOK_URL is not set
    3. Does not fail doc generation when webhook returns HTTP error
    4. Does not fail doc generation when webhook network request throws
    5. Sends separate webhook for each program in multi-program run
  - Updated .env.example with WEBHOOK_URL documentation
  - Updated api.test.ts Config to include webhookUrl: null
  - All 105 tests pass across 6 test suites, build clean
  - Files changed: src/config.ts, src/agent/webhook.ts (new), src/agent/core.ts,
    src/tests/agent.test.ts, src/tests/api.test.ts, src/.env.example

2026-02-13 - Add I5: Agent concurrency (AGENT_CONCURRENCY env, Promise.allSettled)
  - Added agentConcurrency (number) to Config interface, loaded from AGENT_CONCURRENCY env var
    - Defaults to 1, enforces minimum of 1 via Math.max
  - Refactored Agent.processQueue to process items in batches using Promise.allSettled:
    - Splits pending items into batches of size `agentConcurrency`
    - Each batch runs concurrently via Promise.allSettled (no single failure blocks others)
    - Extracted processProgramSafe() method to handle per-item error catching
  - Added QueueItem to agent/core.ts imports for type safety
  - Added 6 new tests in src/tests/agent.test.ts (agent concurrency):
    1. Defaults to concurrency=1 when AGENT_CONCURRENCY not set
    2. Processes multiple programs concurrently with concurrency > 1
    3. Processes items in batches according to concurrency setting
    4. Handles mixed success and failure in concurrent batch
    5. Does not exceed concurrency limit even with large queue
    6. Works correctly with concurrency=1 (sequential behavior preserved)
  - Updated .env.example with AGENT_CONCURRENCY documentation
  - Updated api.test.ts Config to include agentConcurrency: 1
  - All 111 tests pass across 6 test suites, build clean
  - Files changed: src/config.ts, src/agent/core.ts, src/tests/agent.test.ts,
    src/tests/api.test.ts, src/.env.example

2026-02-13 - Verify all tests pass (75+), build clean, web UI loads
  - Ran full test suite: 111 tests pass across 6 test suites (idl, generator, solana-client, store, agent, api)
  - TypeScript build clean: tsc --noEmit exits with zero errors
  - Web UI functional verification:
    - GET / returns 200 with index.html containing SolDocs title and app.js script tag
    - GET /styles.css returns 200 with CSS content
    - GET /app.js returns 200 with JS content
    - GET /api/health returns 200 with {status: "ok"}
  - No issues found, no code changes required
  - Files changed: resources/PRD.md (task marked complete)

2026-02-13 - Prepare deployment artifacts (Dockerfile, docker-compose, README update)
  - Improved Dockerfile with multi-stage build enhancements:
    - Added npm prune --production to strip devDependencies from final image
    - Added non-root user (soldocs) for security
    - Added HEALTHCHECK on /api/health (30s interval, 5s timeout, 3 retries)
    - Renamed build stage from "base" to "build" for clarity
  - Created .dockerignore to exclude node_modules, .git, resources, chats from build context
  - Created docker-compose.yml:
    - Single soldocs service with all env vars passed through from host .env
    - Named volume (soldocs-data) for persistent data across restarts
    - restart: unless-stopped policy
    - Configurable host port via API_PORT env var (default 3000)
  - Updated README.md:
    - Added Docker Compose deployment section with cp .env, up/logs/down commands
    - Added AGENT_CONCURRENCY and WEBHOOK_URL to Configuration table
    - Added webhook.ts to project structure tree
    - Updated test counts: 111 tests across 6 suites (was 64 across 5)
    - Added agent test suite description (36 tests)
    - Updated store test description to mention mutex locking
  - All 111 tests pass across 6 test suites, TypeScript build clean
  - Files changed: Dockerfile, .dockerignore (new), docker-compose.yml (new), README.md,
    resources/PRD.md (task marked complete)

2026-02-14 - Add I6: Startup connection validation (RPC + API key check on boot)
  - Added validateConnections() exported function to src/index.ts:
    - Tests Solana RPC connectivity via getVersion() with retry logic at startup
    - Logs Solana core version on success, throws descriptive error on failure
    - Validates Anthropic API key format (sk-ant- prefix check), warns if invalid
    - Fails fast at startup instead of silently failing later during processing
  - Enhanced startup logging: now shows concurrency setting and webhook URL
  - Created src/tests/startup.test.ts with 6 new tests:
    1. Succeeds when RPC returns a valid version
    2. Throws when RPC connection fails
    3. Throws with RPC URL included in error message
    4. Warns when API key does not start with sk-ant-
    5. Does not warn when API key has correct prefix
    6. Logs the Solana version from the RPC response
  - Updated README.md: test counts (117 across 7 suites), startup test suite,
    security section mentions startup validation
  - All 117 tests pass across 7 test suites, TypeScript build clean
  - Files changed: src/index.ts, src/tests/startup.test.ts (new), README.md,
    resources/PRD.md (task added + marked complete), resources/progress.txt

2026-02-14 - Add T8: Config module tests in src/tests/config.test.ts
  - Created dedicated test file for src/config.ts (previously had ZERO test coverage)
  - Added 25 tests across 6 describe blocks:
    1. Required environment variables (6 tests): throws on missing/empty SOLANA_RPC_URL
       and ANTHROPIC_API_KEY, loads values correctly
    2. Default values (5 tests): verifies apiPort=3000, discoveryInterval=300000,
       webhookUrl=null, agentConcurrency=1, dataDir=src/data
    3. Optional environment variables (4 tests): reads API_PORT, AGENT_DISCOVERY_INTERVAL_MS,
       WEBHOOK_URL, AGENT_CONCURRENCY from env
    4. agentConcurrency minimum enforcement (3 tests): enforces min=1 for 0 and negative,
       allows values > 1
    5. parseInt edge cases (5 tests): leading zeros, non-numeric strings return NaN,
       Math.max(1,NaN) behavior, decimal truncation
    6. Config interface completeness (2 tests): all expected fields present, no extra fields
  - Updated README.md: test counts (142 across 8 suites), added config test suite description
  - All 142 tests pass across 8 test suites, TypeScript build clean
  - Files changed: src/tests/config.test.ts (new), README.md,
    resources/PRD.md (task added + marked complete), resources/progress.txt

2026-02-14 - Add I7: Max retry limit for failed programs (MAX_ATTEMPTS=10)
  - Added exported MAX_ATTEMPTS constant (10) to src/agent/core.ts
  - Added attempt limit check at the start of processProgramSafe():
    - When item.attempts >= MAX_ATTEMPTS, program is marked permanently failed
    - Failed program is saved to index with descriptive errorMessage
    - Item is removed from queue entirely (stops infinite retry loops)
    - Error recorded in agent state for visibility
    - AI is never called for programs that exceeded the limit
  - Added 5 new tests in src/tests/agent.test.ts (max retry limit):
    1. Exports MAX_ATTEMPTS constant set to 10
    2. Removes program from queue after reaching MAX_ATTEMPTS
    3. Records error in agent state when max attempts exceeded
    4. Does not call AI when max attempts already exceeded
    5. Still processes programs below the attempt limit (attempts = MAX_ATTEMPTS - 1)
  - All 147 tests pass across 8 test suites, TypeScript build clean
  - Files changed: src/agent/core.ts, src/tests/agent.test.ts,
    resources/PRD.md (task added + marked complete), resources/progress.txt

2026-02-14 - Fix B5: API input validation hardening (NaN pagination, search param type safety)
  - Fixed NaN pagination bug in GET /api/programs:
    - parseInt() on non-numeric page/limit params (e.g., "abc") returned NaN
    - Math.max(1, NaN) = NaN, causing Array.slice(NaN, NaN) to silently return all results
    - Added Number.isNaN() guards with fallback to defaults (page=1, limit=50)
  - Fixed search parameter type safety:
    - Express parses duplicate query params (?search=a&search=b) as an array
    - Casting array to string via `as string` would fail on .toLowerCase()
    - Added typeof check to safely coerce non-string search params to empty string
  - Added 7 new tests in src/tests/api.test.ts:
    1. Defaults page to 1 when page param is non-numeric
    2. Defaults limit to 50 when limit param is non-numeric
    3. Clamps page to minimum of 1 for negative values
    4. Clamps limit to range [1, 100]
    5. Returns empty array for page beyond total pages
    6. Handles both page and limit as non-numeric gracefully
    7. Ignores non-string search param (duplicate query params)
  - All 154 tests pass across 8 test suites, TypeScript build clean
  - Files changed: src/api/routes.ts, src/tests/api.test.ts,
    resources/PRD.md (task added + marked complete), resources/progress.txt

2026-02-14 - Fix B6: Retry resets attempt counter + DELETE cleans up IDL/doc files
  - Fixed retry attempt counter bug in Store.addToQueue():
    - When a failed program was re-added (retry), status was reset to 'pending'
      but attempts count was preserved from previous failures
    - With MAX_ATTEMPTS=10, a program that failed 9 times would get only 1 retry
      instead of a fresh budget of 10 attempts
    - Now resets attempts to 0 on re-add, giving a full retry budget
  - Fixed DELETE endpoint file orphaning:
    - DELETE /api/programs/:id removed program from index and queue
      but left IDL cache (idls/<id>.json) and doc (docs/<id>.json) files on disk
    - Added Store.removeDocs() and Store.removeIdlCache() methods
    - DELETE route now cleans up all associated files
  - Fixed stale TODO.md checkboxes (T7, B4, I4, I5 were completed but unchecked)
  - Added 6 new tests:
    1. Store: resets attempt counter to zero when re-adding a failed item
    2. Store: removes docs file from disk
    3. Store: removeDocs is a no-op when docs do not exist
    4. Store: removes IDL cache file from disk
    5. Store: removeIdlCache is a no-op when IDL does not exist
    6. API: cleans up IDL cache and doc files on delete
  - Updated README.md: test counts (160 across 8 suites), store (31 tests), API (18 tests)
  - All 160 tests pass across 8 test suites, TypeScript build clean
  - Files changed: src/store/index.ts, src/api/routes.ts, src/tests/store.test.ts,
    src/tests/api.test.ts, TODO.md, README.md, resources/PRD.md, resources/progress.txt

2026-02-14 - Add T9: AI client tests in src/tests/ai-client.test.ts
  - Created dedicated test file for src/ai/client.ts (previously had ZERO test coverage)
  - Added 22 tests across 5 describe blocks:
    1. Constructor (1 test): verifies Anthropic client receives correct API key
    2. Success path (6 tests): text response extraction, custom maxTokens, default maxTokens,
       empty content array, no text block returns empty string, multiple content blocks
    3. Rate limiting (2 tests): enforces 500ms minimum interval between calls,
       no delay when calls are spaced > 500ms apart
    4. Retry logic (11 tests): retries on 429/529/500 errors, exponential backoff (2s/4s),
       throws after 3 failed attempts, does not retry on 401/400/validation errors,
       preserves original error object, throws last error after exhausting retries,
       handles empty error message gracefully
    5. Model configuration (1 test): verifies claude-sonnet-4-5-20250929 model is used
  - Mock pattern: vi.mock('@anthropic-ai/sdk') with shared mockCreate function,
    vi.useFakeTimers for rate limiting and retry delay testing
  - Updated README.md: test counts (182 across 9 suites), added AI client test suite description
  - All 182 tests pass across 9 test suites, TypeScript build clean
  - Files changed: src/tests/ai-client.test.ts (new), README.md,
    resources/PRD.md (task added + marked complete), resources/progress.txt

2026-02-14 - Add T10: Webhook module tests in src/tests/webhook.test.ts
  - Created dedicated test file for src/agent/webhook.ts (previously only tested indirectly via agent integration tests)
  - Added 19 tests across 6 describe blocks:
    1. Payload structure (4 tests): verifies all WebhookPayload fields, POST method, JSON content-type,
       correct webhook URL, valid ISO timestamp
    2. Overview truncation (2 tests): truncates overview to 500 chars, sends full overview when shorter
    3. Instruction count parsing (3 tests): counts ### headers correctly, returns 1 when no headers,
       handles 5+ headers
    4. Error handling (6 tests): throws on HTTP 500/404/403 errors, propagates ECONNREFUSED,
       propagates DNS resolution errors, accepts 201 as success
    5. Timeout (1 test): verifies AbortSignal is passed to fetch
    6. Edge cases (3 tests): empty instructions string returns count=1, empty overview string,
       preserves programId and name from documentation
  - All 201 tests pass across 10 test suites, TypeScript build clean
  - Files changed: src/tests/webhook.test.ts (new), README.md,
    resources/PRD.md (task added + marked complete), resources/progress.txt
